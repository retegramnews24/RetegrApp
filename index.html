<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8">
  <title>RetegrApp v2.0</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  <style>
    html, body { height: 100%; margin: 0; overflow: hidden; }

    /* Sfondo immagine sempre visibile */
    body {
      display: flex; justify-content: center; align-items: center;
      font-family: Arial, sans-serif;
      background: url('https://hd2.tudocdn.net/897898?w=980&h=431') 
                  no-repeat center center fixed;
      background-size: cover;
      color: #fff;
    }
    @keyframes gradientBG {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }

    #app {
      width: 100%; height: 100vh;
      display: flex; flex-direction: column;
      padding: 0; border-radius: 0;
      background: rgba(0,0,0,0.55); backdrop-filter: blur(10px);
      box-shadow: none;
      position: relative;
    }

    h2 { color: #ffeb3b; margin: 10px 0; text-align: center; }
    h3 { color: #81d4fa; margin: 8px 0; }

    .view {
      flex: 1; display: none; flex-direction: column; gap: 15px;
      overflow-y: auto; padding-right: 6px;
      position: relative;
    }
    #menu { display: none; justify-content: center; align-items: center; flex-direction: column; }

    /* Icona rotonda nel menu */
    #menuIcon {
      width: 120px;
      height: 120px;
      background: url('https://hd2.tudocdn.net/897898?w=980&h=431') center/cover no-repeat;
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      color: #ffeb3b;
      font-size: 1.5em;
      font-weight: bold;
      text-shadow: 0 0 8px rgba(0,0,0,0.8);
      margin-bottom: 20px;
      border: 3px solid #81d4fa;
    }

    /* Bottoni grandi e animati */
    .btn {
      padding: 20px 28px; font-size: 1.4em; border: none; border-radius: 14px;
      cursor: pointer; font-weight: 600; color: #fff;
      margin: 12px 0; width: 90%; max-width: none;
      background-size: 300% 300%; animation: btnGradient 6s ease infinite;
      transition: transform 0.2s, box-shadow 0.3s;
    }
    @keyframes btnGradient {
      0% {background-position:0% 50%}
      50% {background-position:100% 50%}
      100% {background-position:0% 50%}
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 14px rgba(0,0,0,0.4); }

    .btn-start { background: linear-gradient(45deg,#43a047,#66bb6a,#1de9b6); }
    .btn-about { background: linear-gradient(45deg,#fbc02d,#ffeb3b,#ff9800); color:#000; }
    .btn-restart { background: linear-gradient(45deg,#e53935,#ff1744,#ff5252); }
    .btn-antistress { background: linear-gradient(45deg,#7b1fa2,#ab47bc,#ce93d8); }

    #versionInfo {
      margin-top: 20px;
      font-size: 1em;
      color: #ccc;
      text-align: center;
      opacity: 0.9;
    }

    a { color: #90caf9; text-decoration: none; }
    a:hover { text-decoration: underline; }

    ul { list-style: none; padding: 0; text-align: left; }
    li { margin: 6px 0; }

    .news-section {
      background: rgba(255,255,255,0.08);
      border-radius: 8px; padding: 10px; margin-bottom: 15px;
    }

    /* About centrato */
    #about { justify-content: center; align-items: center; text-align: center; }
    #about p { font-size: 1.2em; }

    /* Pulsante "Torna al menu" centrato */
    #btnBackNews { align-self: center; margin-top: 15px; }

    /* Data e ora in basso a destra */
    .datetime {
      position: absolute;
      bottom: 10px;
      right: 10px;
      font-size: 0.9em;
      color: #ccc;
      opacity: 0.9;
    }

    /* Intro Scramble */
    #intro {
      position: fixed; inset: 0; display: flex; justify-content: center; align-items: center;
      background: rgba(0,0,0,0.9); z-index: 10; opacity: 1; transition: opacity 600ms ease;
    }
    #intro.hide { opacity: 0; pointer-events: none; }
    #introTitle {
      font-size: clamp(2rem, 8vw, 4rem);
      font-weight: 700; letter-spacing: 0.08em;
      color: #ffeb3b;
    }

    /* Stili per il modal */
    #antistressModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      z-index: 20;
      justify-content: center;
      align-items: center;
    }
    #antistressContent {
      background: #fff;
      border-radius: 12px;
      padding: 20px;
      width: 100%;
      height: 100%;
      max-width: none;
      max-height: none;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    }
    #closeModal {
      position: absolute;
      top: 10px;
      right: 10px;
      background: #e53935;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1em;
    }
    #closeModal:hover {
      background: #ff1744;
    }
    #themeBtn {
      position: absolute;
      top: 10px;
      left: 10px;
      background: #0288d1;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 8px 12px;
      cursor: pointer;
      font-size: 1em;
    }
    #themeBtn:hover {
      background: #039be5;
    }
    #themeDot {
      position: absolute;
      top: 35px;
      left: 15px;
      width: 8px;
      height: 8px;
      background: #000;
      border-radius: 50%;
    }
    #numberConnectContainer.dark #themeDot {
      background: #fff;
    }
    #closeCross {
      position: absolute;
      top: 15px;
      right: 35px;
      width: 8px;
      height: 8px;
      background: none;
      color: #ff0000;
      font-size: 12px;
      line-height: 8px;
      text-align: center;
    }
    /* Stili specifici per Number Connect nel modal */
    #numberConnectContainer {
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(to bottom, #e0f7fa, #f0f0f0);
      padding: 10px;
      border-radius: 8px;
      transition: background 0.3s, color 0.3s;
      position: relative;
      width: 100%;
      height: 100%;
    }
    #numberConnectContainer.dark {
      background: linear-gradient(to bottom, #1e1e1e, #424242);
      color: #fff;
    }
    #numberConnectContainer h1 {
      margin: 20px 0 10px;
      font-size: 2em;
      color: #00796b;
    }
    #numberConnectContainer.dark h1 { color: #4fc3f7; }
    #numberConnectContainer #controls {
      background: #ffffff;
      border-radius: 12px;
      padding: 20px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
      margin-bottom: 15px;
      width: 90%;
      max-width: 400px;
      text-align: center;
    }
    #numberConnectContainer.dark #controls {
      background: #333;
      box-shadow: 0 4px 8px rgba(0,0,0,0.3);
    }
    #numberConnectContainer #controls label {
      font-weight: bold;
      margin-right: 10px;
      font-size: 1.1em;
    }
    #numberConnectContainer.dark #controls label { color: #fff; }
    #numberConnectContainer #controls select {
      padding: 5px 10px;
      font-size: 1em;
      border-radius: 6px;
      border: 1px solid #ccc;
    }
    #numberConnectContainer.dark #controls select { border-color: #666; background: #424242; color: #fff; }
    #numberConnectContainer #startBtn {
      margin-top: 15px;
      padding: 10px 20px;
      font-size: 1.1em;
      background: #00796b;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
    }
    #numberConnectContainer.dark #startBtn { background: #0288d1; }
    #numberConnectContainer #startBtn:hover { background: #004d40; }
    #numberConnectContainer.dark #startBtn:hover { background: #039be5; }
    #numberConnectContainer #asciiArt {
      font-family: monospace;
      color: #444;
      margin-bottom: 10px;
      font-size: 1em;
      text-align: center;
      line-height: 1.4;
    }
    #numberConnectContainer.dark #asciiArt { color: #ccc; }
    #numberConnectContainer #scoreboard {
      margin-bottom: 10px;
      font-weight: bold;
      font-size: 1.2em;
      color: #004d40;
    }
    #numberConnectContainer.dark #scoreboard { color: #4fc3f7; }
    #numberConnectContainer #gameMessage {
      margin-top: 10px;
      font-weight: bold;
      font-size: 1.1em;
      color: #d32f2f;
    }
    #numberConnectContainer.dark #gameMessage { color: #ef5350; }
    #numberConnectContainer #grid {
      display: grid;
      grid-template-columns: repeat(5, 1fr);
      grid-template-rows: repeat(6, 1fr);
      gap: 5px;
      width: 90vw;
      max-width: 500px;
      aspect-ratio: 5 / 6;
      touch-action: none;
    }
    #numberConnectContainer .cell {
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 1.5em;
      font-weight: bold;
      border-radius: 8px;
      cursor: pointer;
      user-select: none;
      transition: transform 0.2s, opacity 0.3s;
      background: #b2dfdb;
      color: #004d40;
    }
    #numberConnectContainer.dark .cell {
      background: #616161;
      color: #fff;
    }
    #numberConnectContainer .cell:hover {
      transform: scale(1.05);
    }
    #numberConnectContainer .cell.selected {
      outline: 3px solid #00796b;
    }
    #numberConnectContainer.dark .cell.selected {
      outline: 3px solid #4fc3f7;
    }
    #numberConnectContainer .cell.pulse {
      animation: pulse 0.3s ease;
    }
    @keyframes pulse {
      0% { transform: scale(1); }
      50% { transform: scale(1.2); }
      100% { transform: scale(1); }
    }
  </style>
</head>
<body>
  <!-- Intro Scramble -->
  <div id="intro"><div id="introTitle">RetegrApp</div></div>

  <div id="app">
    <!-- Menu -->
    <div id="menu" class="view">
      <div id="menuIcon">RetegrApp</div>
      <button class="btn btn-start" id="btnStart">▶️ Avvia</button>
      <button class="btn btn-about" id="btnAbout">ℹ️ About</button>
      <button class="btn btn-antistress" id="btnAntistress">🧘 Antistress</button>
      <button class="btn btn-restart" id="btnRestart">🔄 Riavvia</button>
      <div id="versionInfo">Versione: 2.0</div>
      <div class="datetime" id="menuDatetime"></div>
    </div>

    <!-- Notizie -->
    <div id="news" class="view">
      <h2>📰 Ultime Notizie</h2>
      <div id="newsContainer"></div>
      <button class="btn btn-restart" id="btnBackNews">🔙 Torna al menu</button>
      <div class="datetime" id="newsDatetime"></div>
    </div>

    <!-- About -->
    <div id="about" class="view">
      <h2>ℹ️ Informazioni</h2>
      <p>RetegrApp — versione 2.0</p>
      <p>🔗 Canale Telegram:<br><a href="https://t.me/retegramnews" target="_blank">@retegramnews</a></p>
      <button class="btn btn-restart" id="btnBack2">🔙 Torna al menu</button>
      <div class="datetime" id="aboutDatetime"></div>
    </div>

    <!-- Modal per Number Connect -->
    <div id="antistressModal">
      <div id="antistressContent">
        <button id="closeModal">✖️ Chiudi</button>
        #<div id="closeCross">✖</div>
        #<button id="themeBtn">🌗 Cambia Tema</button>
        #<div id="themeDot"></div>
        <div id="numberConnectContainer">
          <h1>🎮 Number Connect</h1>
          <div id="asciiArt">
            ═══════════════════════════<br>
            🔢 CONNETTI I NUMERI       <br>
            🎯 BATTI IL TUO RECORD     <br>
            ═══════════════════════════
          </div>
          <div id="controls">
            <label for="difficulty">🎚️ Difficoltà:</label>
            <select id="difficulty">
              <option value="easy">🐣 Facile</option>
              <option value="medium">🧩 Media</option>
              <option value="hard">🔥 Difficile</option>
            </select>
            <br>
            <button id="startBtn">▶️ Inizia la partita</button>
          </div>
          <div id="scoreboard">🎯 Punteggio: <span id="score">0</span></div>
          <div id="grid"></div>
          <div id="gameMessage"></div>
          <div class="datetime" id="modalDatetime"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const menu = document.getElementById('menu');
    const news = document.getElementById('news');
    const about = document.getElementById('about');
    const newsContainer = document.getElementById('newsContainer');
    const antistressModal = document.getElementById('antistressModal');
    const btnAntistress = document.getElementById('btnAntistress');
    const closeModal = document.getElementById('closeModal');
    const themeBtn = document.getElementById('themeBtn');
    const numberConnectContainer = document.getElementById('numberConnectContainer');

    // Gestione modalità chiara/scura per il modal
    function toggleTheme() {
      const isDark = numberConnectContainer.classList.toggle('dark');
      localStorage.setItem('antistressTheme', isDark ? 'dark' : 'light');
      themeBtn.textContent = isDark ? '☀️ Modalità Chiara' : '🌙 Modalità Scura';
    }

    // Carica tema salvato per il modal
    if (localStorage.getItem('antistressTheme') === 'dark') {
      numberConnectContainer.classList.add('dark');
      themeBtn.textContent = '☀️ Modalità Chiara';
    } else {
      themeBtn.textContent = '🌙 Modalità Scura';
    }

    themeBtn.addEventListener('click', toggleTheme);

    // Funzione per aggiornare data e ora
    function updateDatetime() {
      const now = new Date();
      const options = { day: '2-digit', month: '2-digit', year: 'numeric', hour: '2-digit', minute: '2-digit', hour12: false };
      const datetimeStr = now.toLocaleString('it-IT', options).replace(',', '');
      document.getElementById('menuDatetime').textContent = datetimeStr;
      document.getElementById('newsDatetime').textContent = datetimeStr;
      document.getElementById('aboutDatetime').textContent = datetimeStr;
      document.getElementById('modalDatetime').textContent = datetimeStr;
    }
    updateDatetime();
    setInterval(updateDatetime, 60000); // Aggiorna ogni minuto

    // Intro con scramble rallentato del 70%
    const intro = document.getElementById("intro");
    const introTitle = document.getElementById("introTitle");
    const text = "RetegrApp";
    const chars = "!<>-_\\/[]{}—=+*^?#________";
    let frame = 0;
    let queue = [];

    function randomChar() { return chars[Math.floor(Math.random() * chars.length)]; }

    function scramble(newText) {
      queue = [];
      for (let i = 0; i < newText.length; i++) {
        queue.push({
          from: text[i] || "",
          to: newText[i],
          start: Math.floor(Math.random() * 34), // Rallentato: 20 * 1.7
          end: Math.floor(Math.random() * 34) + 68 // Rallentato: (20 + 20) * 1.7
        });
      }
      frame = 0;
      update();
    }

    function update() {
      let output = "";
      let complete = 0;
      for (let i = 0; i < queue.length; i++) {
        let { from, to, start, end, char } = queue[i];
        if (frame >= end) {
          complete++;
          output += to;
        } else if (frame >= start) {
          if (!char || Math.random() < 0.28) {
            char = randomChar();
            queue[i].char = char;
          }
          output += `<span style="color:#81d4fa">${char}</span>`;
        } else {
          output += from;
        }
      }
      introTitle.innerHTML = output;
      if (complete === queue.length) {
        setTimeout(() => {
          intro.classList.add("hide");
          setTimeout(() => {
            intro.style.display = "none";
            menu.style.display = "flex";
          }, 600);
        }, 1500);
      } else {
        frame++;
        setTimeout(update, 17); // Rallentato: 10ms * 1.7 ≈ 17ms
      }
    }
    scramble(text);

    // Navigazione
    document.getElementById('btnStart').addEventListener('click', () => {
      menu.style.display = 'none';
      news.style.display = 'flex';
      loadNews();
    });
    document.getElementById('btnAbout').addEventListener('click', () => {
      menu.style.display = 'none'; about.style.display = 'flex';
    });
    document.getElementById('btnRestart').addEventListener('click', () => {
      location.reload();
    });
    document.getElementById('btnBackNews').addEventListener('click', () => {
      news.style.display = 'none'; menu.style.display = 'flex';
    });
    document.getElementById('btnBack2').addEventListener('click', () => {
      about.style.display = 'none'; menu.style.display = 'flex';
    });

    // Gestione modal Antistress
    btnAntistress.addEventListener('click', () => {
      antistressModal.style.display = 'flex';
      initializeNumberConnect();
    });
    closeModal.addEventListener('click', () => {
      antistressModal.style.display = 'none';
    });

    // Feed RSS (50 testate: 25 Italia + 25 Internazionali)
    const feeds = {
      "ANSA":"https://www.ansa.it/sito/ansait_rss.xml",
      "Corriere":"https://xml2.corriereobjects.it/rss/homepage.xml",
      "Repubblica":"https://www.repubblica.it/rss/homepage/rss2.0.xml",
      "La Stampa":"https://www.lastampa.it/rss.xml",
      "Il Sole 24 Ore":"https://www.ilsole24ore.com/rss/italia--1.xml",
      "Il Messaggero":"https://www.ilmessaggero.it/rss/home.xml",
      "Il Fatto Quotidiano":"https://www.ilfattoquotidiano.it/feed/",
      "Il Giornale":"https://www.ilgiornale.it/rss.xml",
      "Il Manifesto":"https://ilmanifesto.it/feed/",
      "Avvenire":"https://www.avvenire.it/rss/avvenire_rss.xml",
      "Libero Quotidiano":"https://www.liberoquotidiano.it/rss/home.xml",
      "Il Foglio":"https://www.ilfoglio.it/rss.jsp",
      "Affaritaliani":"https://www.affaritaliani.it/rss.xml",
      "Adnkronos":"https://www.adnkronos.com/rss.xml",
      "AGI":"https://www.agi.it/rss/ultime-notizie.xml",
      "RaiNews":"https://www.rainews.it/dl/rainews/RSS/cronaca.xml",
      "Fanpage":"https://www.fanpage.it/feed/",
      "La Gazzetta dello Sport":"https://www.gazzetta.it/rss/home.xml",
      "Tuttosport":"https://www.tuttosport.com/rss",
      "Sky TG24":"https://tg24.sky.it/rss/tg24.xml",
      "Quotidiano Nazionale":"https://www.quotidiano.net/rss",
      "Il Mattino":"https://www.ilmattino.it/rss/home.xml",
      "Il Secolo XIX":"https://www.ilsecoloxix.it/rss.xml",
      "La Nazione":"https://www.lanazione.it/rss",
      "Il Resto del Carlino":"https://www.ilrestodelcarlino.it/rss",
      "BBC News":"http://feeds.bbci.co.uk/news/rss.xml",
      "The Guardian":"https://www.theguardian.com/world/rss",
      "The Times":"https://www.thetimes.co.uk/environment/rss",
      "Financial Times":"https://www.ft.com/?format=rss",
      "Sky News":"https://feeds.skynews.com/feeds/rss/home.xml",
      "CNN":"http://rss.cnn.com/rss/edition.rss",
      "New York Times":"https://rss.nytimes.com/services/xml/rss/nyt/HomePage.xml",
      "Washington Post":"https://feeds.washingtonpost.com/rss/world",
      "Wall Street Journal":"https://feeds.a.dj.com/rss/RSSWorldNews.xml",
      "Los Angeles Times":"https://www.latimes.com/world-nation/rss2.0.xml",
      "Bloomberg":"https://www.bloomberg.com/feed/podcast/etf-report.xml",
      "Forbes":"https://www.forbes.com/most-popular/feed/",
      "Politico":"https://www.politico.com/rss/politics08.xml",
      "NBC News":"https://feeds.nbcnews.com/nbcnews/public/news",
      "CBS News":"https://www.cbsnews.com/latest/rss/main",
      "Le Monde":"https://www.lemonde.fr/rss/une.xml",
      "Le Figaro":"https://www.lefigaro.fr/rss/figaro_actualites.xml",
      "El Mundo":"https://e00-elmundo.uecdn.es/elmundo/rss/portada.xml",
      "Der Spiegel":"https://www.spiegel.de/international/index.rss",
      "Die Zeit":"https://newsfeed.zeit.de/index",
      "Deutsche Welle":"https://rss.dw.com/rdf/rss-en-all",
      "Handelsblatt":"https://www.handelsblatt.com/contentexport/feed/schlagzeilen",
      "Al Jazeera":"https://www.aljazeera.com/xml/rss/all.xml",
      "The Hindu":"https://www.thehindu.com/feeder/default.rss",
      "Times of India":"https://timesofindia.indiatimes.com/rssfeeds/-2128936835.cms"
    };

    async function loadNews() {
      newsContainer.innerHTML = "";
      for (const [fonte, url] of Object.entries(feeds)) {
        const section = document.createElement("div");
        section.className = "news-section";
        section.innerHTML = `<h3>${fonte}</h3><ul></ul>`;
        newsContainer.appendChild(section);
        const ul = section.querySelector("ul");

        try {
          const res = await fetch("https://api.allorigins.win/get?url=" + encodeURIComponent(url));
          const data = await res.json();
          const doc = new DOMParser().parseFromString(data.contents, "text/xml");
          const items = doc.querySelectorAll("item, entry");

          items.forEach((item, i) => {
            if (i < 10) {
              const titleNode = item.querySelector("title");
              const linkNode = item.querySelector("link");
              const title = titleNode ? titleNode.textContent : "Titolo non disponibile";
              const link = linkNode ? (linkNode.getAttribute("href") || linkNode.textContent) : "";

              const li = document.createElement("li");
              li.innerHTML = link ? `<a href="${link}" target="_blank">${title}</a>` : `${title}`;
              ul.appendChild(li);
            }
          });
        } catch {
          const err = document.createElement("p");
          err.textContent = "⚠️ in caricamento";
          section.appendChild(err);
        }
      }
    }

    // Script per Number Connect
    function initializeNumberConnect() {
      const grid = document.getElementById('grid');
      const difficultySelect = document.getElementById('difficulty');
      const startBtn = document.getElementById('startBtn');
      const scoreEl = document.getElementById('score');
      const gameMessage = document.getElementById('gameMessage');
      const rows = 6, cols = 5;
      let cells = [], selected = [], colorMap = {};
      let score = 0, lastMergeTime = 0;
      let isSelecting = false;

      function getRange() {
        switch (difficultySelect.value) {
          case 'easy': return 4;
          case 'medium': return 6;
          case 'hard': return 9;
        }
      }

      function generateNumber() {
        return Math.pow(2, Math.floor(Math.random() * getRange()) + 1);
      }

      function getColorForNumber(n) {
        if (!colorMap[n]) {
          const hue = (Object.keys(colorMap).length * 47) % 360;
          colorMap[n] = `hsl(${hue}, 70%, 85%)`;
        }
        return colorMap[n];
      }

      function createGrid() {
        grid.innerHTML = '';
        cells = [];
        selected = [];
        colorMap = {};
        score = 0;
        updateScore();
        gameMessage.textContent = '';
        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < cols; x++) {
            const div = document.createElement('div');
            div.className = 'cell';
            div.dataset.x = x;
            div.dataset.y = y;
            const num = generateNumber();
            div.textContent = num;
            div.style.background = getColorForNumber(num);
            grid.appendChild(div);
            cells.push(div);
          }
        }
      }

      function getCell(x, y) {
        return cells.find(c => parseInt(c.dataset.x) === x && parseInt(c.dataset.y) === y);
      }

      function areAdjacent(c1, c2) {
        const x1 = parseInt(c1.dataset.x), y1 = parseInt(c1.dataset.y);
        const x2 = parseInt(c2.dataset.x), y2 = parseInt(c2.dataset.y);
        const dx = Math.abs(x1 - x2);
        const dy = Math.abs(y1 - y2);
        return dx <= 1 && dy <= 1 && (dx + dy > 0);
      }

      function addToSelection(cell) {
        if (selected.length >= 2 || !cell.textContent) return;
        if (selected.length === 1 && !areAdjacent(selected[0], cell)) return;
        if (selected.length === 1 && selected[0].textContent !== cell.textContent) return;
        selected.push(cell);
        cell.classList.add('selected');
      }

      function clearSelection() {
        selected.forEach(c => c.classList.remove('selected'));
        selected = [];
      }

      function mergeSelection() {
        if (selected.length !== 2) return clearSelection();
        const [c1, c2] = selected;
        if (!areAdjacent(c1, c2) || c1.textContent !== c2.textContent) return clearSelection();
        const sum = parseInt(c1.textContent) + parseInt(c2.textContent);
        c2.textContent = sum;
        c2.style.background = getColorForNumber(sum);
        c2.classList.add('pulse');
        setTimeout(() => c2.classList.remove('pulse'), 300);
        c1.textContent = '';
        c1.style.background = numberConnectContainer.classList.contains('dark') ? '#424242' : '#fff';
        c1.style.opacity = '0.5';
        setTimeout(() => c1.style.opacity = '1', 300);
        const now = Date.now();
        const combo = (now - lastMergeTime < 3000) ? 2 : 1;
        lastMergeTime = now;
        score += sum * combo;
        updateScore();
        clearSelection();
        setTimeout(() => {
          dropAndFill();
          if (!hasAvailableMoves()) {
            gameMessage.textContent = "Fine partita! Nessuna mossa disponibile.";
          } else {
            gameMessage.textContent = "";
          }
        }, 300);
      }

      function dropAndFill() {
        for (let x = 0; x < cols; x++) {
          let nums = [];
          for (let y = rows - 1; y >= 0; y--) {
            const cell = getCell(x, y);
            if (cell.textContent) nums.push(cell.textContent);
          }
          for (let y = rows - 1; y >= 0; y--) {
            const cell = getCell(x, y);
            const val = nums.length > 0 ? nums.shift() : generateNumber();
            cell.textContent = val;
            cell.style.background = getColorForNumber(val);
          }
        }
      }

      function updateScore() {
        scoreEl.textContent = score;
      }

      function hasAvailableMoves() {
        for (let y = 0; y < rows; y++) {
          for (let x = 0; x < cols; x++) {
            const cell = getCell(x, y);
            if (!cell.textContent) continue;
            const val = cell.textContent;
            const neighbors = [
              getCell(x + 1, y),
              getCell(x - 1, y),
              getCell(x, y + 1),
              getCell(x, y - 1),
              getCell(x + 1, y + 1),
              getCell(x + 1, y - 1),
              getCell(x - 1, y + 1),
              getCell(x - 1, y - 1)
            ];
            if (neighbors.some(n => n && n.textContent === val)) {
              return true;
            }
          }
        }
        return false;
      }

      grid.addEventListener('mousedown', e => {
        e.preventDefault();
        const cell = e.target.closest('.cell');
        if (cell) {
          if (!isSelecting) {
            clearSelection();
            isSelecting = true;
            addToSelection(cell);
          }
        }
      });

      grid.addEventListener('mouseover', e => {
        if (isSelecting) {
          const cell = e.target.closest('.cell');
          if (cell) addToSelection(cell);
        }
      });

      grid.addEventListener('mouseup', e => {
        if (isSelecting) {
          const cell = e.target.closest('.cell');
          if (cell && !selected.includes(cell)) addToSelection(cell);
          mergeSelection();
          isSelecting = false;
        }
      });

      grid.addEventListener('touchstart', e => {
        e.preventDefault();
        const cell = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
        if (cell && cell.classList.contains('cell')) {
          clearSelection();
          isSelecting = true;
          addToSelection(cell);
        }
      });

      grid.addEventListener('touchmove', e => {
        if (isSelecting) {
          e.preventDefault();
          const cell = document.elementFromPoint(e.touches[0].clientX, e.touches[0].clientY);
          if (cell && cell.classList.contains('cell')) {
            addToSelection(cell);
          }
        }
      });

      grid.addEventListener('touchend', e => {
        if (isSelecting) {
          e.preventDefault();
          const cell = document.elementFromPoint(e.changedTouches[0].clientX, e.changedTouches[0].clientY);
          if (cell && cell.classList.contains('cell') && !selected.includes(cell)) {
            addToSelection(cell);
          }
          mergeSelection();
          isSelecting = false;
        }
      });

      startBtn.addEventListener('click', createGrid);
      createGrid();
    }
  </script>
</body>
</html>
